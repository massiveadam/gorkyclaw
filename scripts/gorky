#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "${SCRIPT_DIR}/../scripts/doctor.sh" ]]; then
  ROOT_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"
else
  ROOT_DIR="${GORKY_HOME:-$HOME/nanoclaw}"
fi

if [[ ! -d "$ROOT_DIR" || ! -f "$ROOT_DIR/scripts/doctor.sh" ]]; then
  echo "Could not locate NanoClaw repo."
  echo "Set GORKY_HOME to your repo path, e.g.:"
  echo "export GORKY_HOME=~/nanoclaw"
  exit 1
fi

cd "$ROOT_DIR"

cmd="${1:-start}"

start_all() {
  if [[ ! -f ".env" ]]; then
    echo ".env not found. Run ./scripts/onboard.sh first."
    exit 1
  fi

  set -a
  # shellcheck disable=SC1091
  source .env
  set +a

  mkdir -p infra/data
  npm run build >/dev/null

  docker rm -f openclaw-anthropic-proxy openclaw-runner 2>/dev/null || true
  docker run -d --name openclaw-anthropic-proxy --restart unless-stopped \
    --env-file .env -e PORT=3000 -p 3000:3000 openclaw-anthropic-proxy:latest >/dev/null
  docker run -d --name openclaw-runner --restart unless-stopped \
    --env-file .env -e PORT=8080 -p 8080:8080 \
    --add-host host.docker.internal:host-gateway \
    -v "$HOME/.ssh:/app/keys:ro" -v "$PWD/infra/data:/app/data" \
    nanoclaw-ops-runner:latest >/dev/null

  if [[ "${OPENCODE_LOCAL_AUTOSTART:-false}" == "true" ]]; then
    ./scripts/opencode-local-start.sh || true
  fi

  sudo systemctl restart nanoclaw
  echo "NanoClaw stack started."
  ./scripts/doctor.sh
}

stop_all() {
  docker rm -f openclaw-anthropic-proxy openclaw-runner 2>/dev/null || true
  sudo systemctl stop nanoclaw || true
  echo "NanoClaw stack stopped."
}

status_all() {
  ./scripts/doctor.sh
}

logs_all() {
  sudo journalctl -u nanoclaw -f
}

case "$cmd" in
  start) start_all ;;
  stop) stop_all ;;
  restart) stop_all; start_all ;;
  status) status_all ;;
  logs) logs_all ;;
  onboard) ./scripts/onboard.sh ;;
  self) ./scripts/self-model-report.sh ;;
  addons) ./scripts/addon-list.sh ;;
  addon-install) shift; ./scripts/addon-install.sh "$@" ;;
  addon-create) shift; ./scripts/addon-create.sh "$@" ;;
  addon-run) shift; ./scripts/addon-run.sh "$@" ;;
  export-addons) shift; ./scripts/export-addons.sh "$@" ;;
  import-addons) shift; ./scripts/import-addons.sh "$@" ;;
  opencode-start) ./scripts/opencode-local-start.sh ;;
  opencode-stop) ./scripts/opencode-local-stop.sh ;;
  opencode-status) ./scripts/opencode-local-status.sh ;;
  *)
    echo "Usage: gorky [start|stop|restart|status|logs|onboard|self|addons|addon-install <name>|addon-create <name> [purpose]|addon-run <name> [input]|export-addons [file]|import-addons <file>|opencode-start|opencode-stop|opencode-status]"
    exit 1
    ;;
esac
